<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Embed Python (URL-coded starter)</title>

  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  <style>
    html,body { height:100%; margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .container { display:flex; height:100vh; box-sizing:border-box; }
    /* single column: editor + console stack */
    .panel { flex:1 1 100%; display:flex; flex-direction:column; padding:10px; box-sizing:border-box; min-width:360px; }
    .header { display:flex; align-items:center; gap:8px; }
    .spacer { flex:1; }
    button { padding:8px 12px; cursor:pointer; }
    /* Editor area and Output area share vertical space equally by default */
    .editor-area { flex:1 1 50%; min-height:80px; box-sizing:border-box; border:1px solid #ddd; border-radius:4px; overflow:hidden; }
    .output-area { flex:1 1 50%; min-height:80px; box-sizing:border-box; margin-top:10px; border:1px solid #222; border-radius:4px;
                   background:#0b0b0b; color:#b6f39b; padding:8px; white-space:pre-wrap; overflow:auto; resize:vertical; }
    /* ensure CodeMirror fills editor-area */
    .CodeMirror { height:100% !important; }
    /* make reset / copy controls small when visible */
    .controls { display:flex; gap:8px; align-items:center; margin-left:8px; }
    /* small note */
    .note { font-size:12px; color:#666; margin-left:8px; }
    /* Responsive fallback */
    @media (max-width:900px) {
      .container { flex-direction:column; }
      .panel { padding:8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel" id="main-panel">
      <div class="header">
        <h3 style="margin:0;">Python Editor</h3>
        <div class="spacer"></div>

        <!-- Visible when opened directly (instructors). Hidden when embedded (iframe). -->
        <div id="teacher-controls" class="controls" aria-hidden="false">
          <button id="copyIframe">Copy embed iframe</button>
          <button id="copyDirect">Copy direct URL</button>
        </div>

        <div style="width:8px;"></div>

        <button id="runBtn">Run â–¶</button>
        <button id="resetBtn" title="Reset to initial code" style="margin-left:6px;">Reset</button>
      </div>

      <div class="editor-area" id="editor-area">
        <textarea id="code" style="display:none;">
# default starter template
def greet(name):
    return f"Hello, {name}!"

for n in ["Alice","Bob","Student"]:
    print(greet(n))
        </textarea>
      </div>

      <pre id="output" class="output-area" aria-live="polite"></pre>
      <div style="height:6px;"></div>
      <div style="display:flex; align-items:center; gap:8px; margin-top:6px;">
        <div class="note">Runtime: Pyodide (client-side)</div>
      </div>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

  <script>
    // dynamic load of pyodide
    (function () {
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js';
      s.onload = initPyodide;
      document.head.appendChild(s);
    })();

    // ---------- helpers: unicode-safe base64 ----------
    function b64EncodeUnicode(str) {
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode('0x' + p1);
      }));
    }
    function b64DecodeUnicode(str) {
      return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }

    function readCodeFromFragment() {
      const hash = location.hash || '';
      if (!hash) return null;
      const m = hash.match(/(?:#|&)?code=([^&]+)/);
      if (m && m[1]) {
        try { return b64DecodeUnicode(decodeURIComponent(m[1])); } catch (e) { console.warn('decode fail', e); }
      }
      return null;
    }

    // ---------- state ----------
    let pyodide = null;
    let editor = null;
    const templateNode = document.getElementById('code');
    const defaultTemplate = templateNode.textContent.trim();
    // initial code for this loaded frame (either from fragment or default)
    let initialCode = defaultTemplate;

    async function initPyodide() {
      const out = document.getElementById('output');
      out.textContent = 'Loading Python runtime (Pyodide)...\n';
      try {
        pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/' });
        out.textContent += 'Pyodide ready.\n';
      } catch (e) {
        out.textContent = 'Failed to load Pyodide: ' + e;
        console.error(e);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      // initialize CodeMirror
      editor = CodeMirror.fromTextArea(templateNode, {
        mode: 'python', lineNumbers: true, indentUnit: 4, tabSize: 4
      });

      // make editor fill the editor-area
      const edWrapper = editor.getWrapperElement();
      edWrapper.style.height = '100%';

      // If there is code encoded in the URL fragment, use that as initial
      const fragCode = readCodeFromFragment();
      if (fragCode) {
        editor.setValue(fragCode);
        initialCode = fragCode; // frame-specific initial code
      } else {
        editor.setValue(defaultTemplate);
        initialCode = defaultTemplate;
      }

      // hide teacher controls when embedded in an iframe (so they don't show inside Canvas)
      const teacherControls = document.getElementById('teacher-controls');
      try {
        if (window.self !== window.top) {
          teacherControls.style.display = 'none';
          teacherControls.setAttribute('aria-hidden','true');
        }
      } catch (e) {
        // cross-origin iframe -> assume embedded; hide controls
        teacherControls.style.display = 'none';
        teacherControls.setAttribute('aria-hidden','true');
      }

      // wire buttons
      document.getElementById('runBtn').addEventListener('click', runCode);
      document.getElementById('resetBtn').addEventListener('click', () => {
        editor.setValue(initialCode);
        document.getElementById('output').textContent = 'Reset to initial code for this frame.';
        editor.refresh && editor.refresh();
      });

      // teacher copy functions only available when teacher controls visible
      document.getElementById('copyIframe').addEventListener('click', copyIframeSnippet);
      document.getElementById('copyDirect').addEventListener('click', copyDirectURL);

      // refresh editor on mouse up (after dragging the output resizer)
      window.addEventListener('mouseup', ()=> editor.refresh && editor.refresh());
      window.addEventListener('touchend', ()=> editor.refresh && editor.refresh());
      window.addEventListener('resize', ()=> editor.refresh && editor.refresh());
    });

    // write output helper for python to call
    window.writeOutputLine = function(s) {
      const out = document.getElementById('output');
      out.textContent += s;
      out.scrollTop = out.scrollHeight;
    };

    // run user code with stdout/stderr captured to JS
    async function runCode() {
      if (!pyodide) {
        document.getElementById('output').textContent = 'Runtime still loading. Please wait...\n';
        return;
      }
      const code = editor.getValue();
      const out = document.getElementById('output');
      out.textContent = ''; // clear

      try {
        await pyodide.runPythonAsync(`
import sys, js
class _Writer:
    def write(self, x):
        if x:
            js.writeOutputLine(x)
    def flush(self): pass
sys.stdout = _Writer()
sys.stderr = _Writer()
`);
        await pyodide.runPythonAsync(code);
      } catch (err) {
        out.textContent += '\nError:\n' + err;
        console.error(err);
      }
    }

    // ---------- teacher helpers ----------
    function makeFragmentForCode(text) {
      const b64 = b64EncodeUnicode(text);
      return '#code=' + encodeURIComponent(b64);
    }

    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(()=> alert('Copied to clipboard'));
      } else {
        prompt('Copy the text below', text);
      }
    }

    function copyIframeSnippet() {
      const code = editor.getValue();
      const frag = makeFragmentForCode(code);
      const src = location.origin + location.pathname + frag;
      const iframe = `<iframe src="${src}" width="100%" height="720" frameborder="0" title="Embedded Python"></iframe>`;
      copyToClipboard(iframe);
    }

    function copyDirectURL() {
      const code = editor.getValue();
      const frag = makeFragmentForCode(code);
      const src = location.origin + location.pathname + frag;
      copyToClipboard(src);
    }
  </script>
</body>
</html>
