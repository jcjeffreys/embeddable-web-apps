<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Embed Python (URL-coded starter)</title>

  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css" />
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    .container{display:flex;height:100vh;box-sizing:border-box;}
    .left{width:50%;padding:12px;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;min-width:420px;overflow:hidden;}
    .right{width:50%;padding:18px;overflow-y:auto;}
    .CodeMirror{height:46% !important;}
    #output{flex:1 1 auto;overflow:auto;background:#0b0b0b;color:#b6f39b;padding:10px;white-space:pre-wrap;border:1px solid #222;border-radius:4px;}
    .controls{display:flex;gap:8px;align-items:center;margin-top:8px;}
    button{padding:8px 12px;cursor:pointer;}
    h3,h4{margin:0;}
  </style>
</head>
<body>
  <div class="container">
    <div class="left" id="left-panel">
      <div style="display:flex;align-items:center;">
        <h3 style="margin:0;">Python Editor</h3>
        <div style="flex:1"></div>
        <button id="runBtn">Run â–¶</button>
        <button id="resetBtn" style="margin-left:6px;">Reset</button>
      </div>

      <!-- editor -->
      <div id="editor" style="margin-top:10px;">
        <textarea id="code" style="display:none;">
# default starter template
def greet(name):
    return f"Hello, {name}!"

for n in ["Alice","Bob","Student"]:
    print(greet(n))
        </textarea>
      </div>

      <div style="margin-top:12px; display:flex; flex-direction:column; height:calc(54% - 12px);">
        <div style="display:flex;align-items:center;gap:8px;">
          <h4 style="margin:0;">Console Output</h4>
          <div style="flex:1"></div>
          <div style="font-size:13px;color:#666;">Runtime: Pyodide (client)</div>
        </div>
        <pre id="output" aria-live="polite"></pre>

        <div class="controls" style="margin-top:8px;">
          <button id="copyIframe">Copy embed iframe</button>
          <button id="copyDirect">Copy direct URL</button>
          <span style="font-size:13px;color:#555;">(Use these to embed the page w/ starter code)</span>
        </div>
      </div>
    </div>

    <div class="right" id="instructions">
      <h2>Instructions</h2>
      <p>Welcome. Edit code on the left. Press <strong>Run</strong>. Use "Copy embed iframe" (instructor) to create a Canvas iframe that contains the starter code in the URL fragment. Students' edits are local only.</p>
      <h3>How to create an embed for Canvas</h3>
      <ol>
        <li>Open this hosted page in your browser and edit the starter code to the skeleton you want.</li>
        <li>Click <strong>Copy embed iframe</strong>. That copies an &lt;iframe src="...#code=..."&gt; snippet to your clipboard.</li>
        <li>Paste that snippet into Canvas (in HTML editor for the Page). The embedded instance will load that template and will not save student edits anywhere.</li>
      </ol>
      <p style="margin-top:300px;">(This right-hand area scrolls independently.)</p>
    </div>
  </div>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

  <!-- Load Pyodide -->
  <script>
    (function () {
      const pyodideScript = document.createElement('script');
      pyodideScript.src = 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js';
      pyodideScript.onload = initPyodide;
      document.head.appendChild(pyodideScript);
    })();

    // ---------- helpers ----------
    function b64EncodeUnicode(str) {
      return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function(match, p1) {
        return String.fromCharCode('0x' + p1);
      }));
    }
    function b64DecodeUnicode(str) {
      return decodeURIComponent(Array.prototype.map.call(atob(str), function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
    }

    function readCodeFromFragment() {
      const hash = location.hash || '';
      if (!hash) return null;
      const m = hash.match(/(?:#|&)?code=([^&]+)/);
      if (m && m[1]) {
        try { return b64DecodeUnicode(decodeURIComponent(m[1])); } catch (e) { console.warn('decode fail', e); }
      }
      return null;
    }

    // ---------- main ----------
    let pyodide = null;
    let editor = null;
    const templateNode = document.getElementById('code');
    const defaultTemplate = templateNode.textContent.trim();

    async function initPyodide() {
      const out = document.getElementById('output');
      out.textContent = 'Loading Python runtime (Pyodide)...';
      try {
        pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.23.4/full/' });
        out.textContent += '\nPyodide ready.\n';
      } catch (e) {
        out.textContent = 'Failed to load Pyodide: ' + e;
        console.error(e);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      editor = CodeMirror.fromTextArea(templateNode, {
        mode: 'python', lineNumbers: true, indentUnit: 4, tabSize: 4
      });

      const fragCode = readCodeFromFragment();
      if (fragCode) editor.setValue(fragCode);

      editor.getWrapperElement().style.height = '46%';

      document.getElementById('runBtn').addEventListener('click', runCode);
      document.getElementById('resetBtn').addEventListener('click', () => {
        editor.setValue(defaultTemplate);
        document.getElementById('output').textContent = 'Reset to template.';
      });

      document.getElementById('copyIframe').addEventListener('click', copyIframeSnippet);
      document.getElementById('copyDirect').addEventListener('click', copyDirectURL);
    });

    async function runCode() {
      if (!pyodide) {
        document.getElementById('output').textContent = 'Runtime still loading. Please wait...';
        return;
      }
      const code = editor.getValue();
      const out = document.getElementById('output');
      out.textContent = '';
      try {
        await pyodide.runPythonAsync(`
import sys, js
class _Writer:
    def write(self, x):
        if x:
            js.writeOutputLine(x)
    def flush(self): pass
sys.stdout = _Writer()
sys.stderr = _Writer()
`);
        await pyodide.runPythonAsync(code);
      } catch (err) {
        out.textContent += '\\nError:\\n' + err;
        console.error(err);
      }
    }

    window.writeOutputLine = function (s) {
      const out = document.getElementById('output');
      out.textContent += s;
      out.scrollTop = out.scrollHeight;
    };

    function makeFragmentForCode(text) {
      const b64 = b64EncodeUnicode(text);
      return '#code=' + encodeURIComponent(b64);
    }

    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(()=> alert('Copied to clipboard'));
      } else {
        prompt('Copy the text below', text);
      }
    }

    function copyIframeSnippet() {
      const code = editor.getValue();
      const frag = makeFragmentForCode(code);
      const src = location.origin + location.pathname + frag;
      const iframe = `<iframe src="${src}" width="100%" height="720" frameborder="0" title="Embedded Python"></iframe>`;
      copyToClipboard(iframe);
    }

    function copyDirectURL() {
      const code = editor.getValue();
      const frag = makeFragmentForCode(code);
      const src = location.origin + location.pathname + frag;
      copyToClipboard(src);
    }
  </script>
</body>
</html>
